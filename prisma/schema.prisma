generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum OrgRole {
  ADMIN
  AUDITOR
  MANAGER
  VIEWER
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum FrameworkStatus {
  DRAFT
  PUBLISHED
  DEPRECATED
}

enum AssessmentStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ARCHIVED
}

enum ComplianceStatus {
  NOT_ASSESSED
  NON_COMPLIANT
  PARTIALLY_COMPLIANT
  COMPLIANT
}

enum RiskLikelihood {
  VERY_LOW
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum RiskImpact {
  NEGLIGIBLE
  MINOR
  MODERATE
  MAJOR
  CATASTROPHIC
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskTreatment {
  ACCEPT
  MITIGATE
  TRANSFER
  AVOID
}

enum RiskStatus {
  IDENTIFIED
  ANALYSED
  TREATMENT_PLANNED
  TREATMENT_IN_PROGRESS
  TREATED
  CLOSED
  MONITORING
}

enum ControlImplStatus {
  NOT_IMPLEMENTED
  PLANNED
  PARTIALLY_IMPLEMENTED
  FULLY_IMPLEMENTED
  NOT_APPLICABLE
}

enum ControlEffectiveness {
  NOT_TESTED
  INEFFECTIVE
  PARTIALLY_EFFECTIVE
  EFFECTIVE
}

enum DocumentStatus {
  DRAFT
  PENDING_REVIEW
  PENDING_APPROVAL
  APPROVED
  SUPERSEDED
  OBSOLETE
}

enum ApprovalAction {
  SUBMITTED
  REVIEWED
  APPROVED
  REJECTED
  RETURNED_FOR_REVISION
}

enum AuditType {
  INTERNAL
  EXTERNAL
  SURVEILLANCE
  CERTIFICATION
  RECERTIFICATION
}

enum AuditStatus {
  PLANNED
  IN_PROGRESS
  FIELDWORK_COMPLETE
  REPORT_DRAFT
  REPORT_FINAL
  CLOSED
}

enum FindingSeverity {
  OBSERVATION
  OPPORTUNITY_FOR_IMPROVEMENT
  MINOR_NONCONFORMITY
  MAJOR_NONCONFORMITY
}

enum FindingStatus {
  OPEN
  IN_PROGRESS
  CORRECTIVE_ACTION_TAKEN
  VERIFIED
  CLOSED
}

enum EvidenceType {
  DOCUMENT
  SCREENSHOT
  LOG
  CERTIFICATE
  POLICY
  PROCEDURE
  RECORD
  EXTERNAL_LINK
  OTHER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  COMPLETED
  CANCELLED
  OVERDUE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ApplicabilityStatus {
  APPLICABLE
  NOT_APPLICABLE
}

enum CAPAType {
  CORRECTIVE
  PREVENTIVE
}

enum CAPAStatus {
  OPEN
  ROOT_CAUSE_ANALYSIS
  ACTION_PLANNED
  ACTION_IN_PROGRESS
  VERIFICATION
  CLOSED
  CLOSED_INEFFECTIVE
}

enum TrainingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  OVERDUE
  WAIVED
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_DUE_SOON
  TASK_OVERDUE
  DOCUMENT_PENDING_APPROVAL
  DOCUMENT_APPROVED
  DOCUMENT_REJECTED
  AUDIT_SCHEDULED
  FINDING_ASSIGNED
  CAPA_ASSIGNED
  RISK_REVIEW_DUE
  TRAINING_ASSIGNED
  TRAINING_OVERDUE
  ASSESSMENT_COMPLETED
}

enum ActivityAction {
  CREATED
  UPDATED
  DELETED
  APPROVED
  REJECTED
  SUBMITTED
  ASSIGNED
  COMPLETED
  COMMENTED
  UPLOADED
  STATUS_CHANGED
}

// ─── NextAuth Models ─────────────────────────────────────────────────────────

model User {
  id             String    @id @default(cuid())
  name           String?
  email          String    @unique
  emailVerified  DateTime?
  image          String?
  hashedPassword String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  accounts          Account[]
  sessions          Session[]
  memberships       Membership[]
  documentApprovals DocumentApproval[]
  auditTeamMembers  AuditTeamMember[]
  tasksAssigned     Task[]              @relation("TaskAssignee")
  tasksCreated      Task[]              @relation("TaskCreator")
  trainingRecords   TrainingRecord[]
  auditLogs         AuditLog[]
  notifications     Notification[]
  comments          Comment[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Organization & Multi-Tenancy ────────────────────────────────────────────

model Organization {
  id        String    @id @default(cuid())
  name      String
  slug      String    @unique
  logo      String?
  industry  String?
  size      String?
  settings  Json      @default("{}")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  memberships            Membership[]
  invitations            Invitation[]
  assessments            Assessment[]
  riskCategories         RiskCategory[]
  risks                  Risk[]
  controlImplementations ControlImplementation[]
  documents              Document[]
  audits                 Audit[]
  evidences              Evidence[]
  tasks                  Task[]
  soaEntries             SoAEntry[]
  capas                  CAPA[]
  trainingPrograms       TrainingProgram[]
  auditLogs              AuditLog[]
  notifications          Notification[]
  tags                   Tag[]
  comments               Comment[]
}

model Membership {
  id        String   @id @default(cuid())
  userId    String
  orgId     String
  role      OrgRole  @default(VIEWER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
  @@index([orgId])
}

model Invitation {
  id        String       @id @default(cuid())
  email     String
  role      OrgRole      @default(VIEWER)
  token     String       @unique @default(cuid())
  orgId     String
  status    InviteStatus @default(PENDING)
  expiresAt DateTime
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([token])
}

// ─── Framework & Standards ───────────────────────────────────────────────────

model Framework {
  id          String          @id @default(cuid())
  code        String          @unique
  name        String
  version     String
  description String?
  status      FrameworkStatus @default(DRAFT)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  clauses     Clause[]
  assessments Assessment[]
  soaEntries  SoAEntry[]
}

model Clause {
  id          String  @id @default(cuid())
  frameworkId String
  parentId    String?
  number      String
  title       String
  description String? @db.Text
  isAnnex     Boolean @default(false)
  sortOrder   Int     @default(0)

  framework Framework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  parent    Clause?   @relation("ClauseHierarchy", fields: [parentId], references: [id])
  children  Clause[]  @relation("ClauseHierarchy")
  controls  Control[]

  assessmentResponses AssessmentResponse[] @relation("ClauseResponses")

  @@index([frameworkId])
  @@index([parentId])
}

model Control {
  id        String  @id @default(cuid())
  clauseId  String
  number    String
  title     String
  category  String?
  objective String? @db.Text
  guidance  String? @db.Text

  clause       Clause        @relation(fields: [clauseId], references: [id], onDelete: Cascade)
  requirements Requirement[]

  implementations ControlImplementation[]
  soaEntries      SoAEntry[]

  assessmentResponses AssessmentResponse[] @relation("ControlResponses")

  @@index([clauseId])
}

model Requirement {
  id          String  @id @default(cuid())
  controlId   String
  number      String
  description String  @db.Text
  isMandatory Boolean @default(true)

  control Control @relation(fields: [controlId], references: [id], onDelete: Cascade)

  assessmentResponses AssessmentResponse[] @relation("RequirementResponses")

  @@index([controlId])
}

// ─── Assessment ──────────────────────────────────────────────────────────────

model Assessment {
  id           String           @id @default(cuid())
  orgId        String
  frameworkId  String
  name         String
  status       AssessmentStatus @default(NOT_STARTED)
  overallScore Float?
  startDate    DateTime?
  endDate      DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  framework Framework    @relation(fields: [frameworkId], references: [id])

  responses AssessmentResponse[]

  @@index([orgId])
  @@index([frameworkId])
}

model AssessmentResponse {
  id               String           @id @default(cuid())
  assessmentId     String
  clauseId         String?
  controlId        String?
  requirementId    String?
  complianceStatus ComplianceStatus @default(NOT_ASSESSED)
  maturityLevel    Int?
  gaps             String?          @db.Text
  recommendations  String?          @db.Text
  notes            String?          @db.Text
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  assessment  Assessment   @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  clause      Clause?      @relation("ClauseResponses", fields: [clauseId], references: [id])
  control     Control?     @relation("ControlResponses", fields: [controlId], references: [id])
  requirement Requirement? @relation("RequirementResponses", fields: [requirementId], references: [id])

  @@index([assessmentId])
}

// ─── Risk Management ─────────────────────────────────────────────────────────

model RiskCategory {
  id    String @id @default(cuid())
  orgId String
  name  String
  color String @default("#6B7280")

  org   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  risks Risk[]

  @@unique([orgId, name])
  @@index([orgId])
}

model Risk {
  id          String  @id @default(cuid())
  orgId       String
  categoryId  String?
  title       String
  description String? @db.Text
  owner       String?

  inherentLikelihood RiskLikelihood @default(MEDIUM)
  inherentImpact     RiskImpact     @default(MODERATE)
  inherentScore      Int            @default(0)
  inherentLevel      RiskLevel      @default(MEDIUM)

  residualLikelihood RiskLikelihood @default(MEDIUM)
  residualImpact     RiskImpact     @default(MODERATE)
  residualScore      Int            @default(0)
  residualLevel      RiskLevel      @default(MEDIUM)

  targetLikelihood RiskLikelihood?
  targetImpact     RiskImpact?
  targetScore      Int?
  targetLevel      RiskLevel?

  treatment     RiskTreatment @default(MITIGATE)
  status        RiskStatus    @default(IDENTIFIED)
  reviewDate    DateTime?
  treatmentPlan String?       @db.Text

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  org      Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  category RiskCategory? @relation(fields: [categoryId], references: [id])

  controlMappings RiskControlMapping[]
  tasks           Task[]

  @@index([orgId])
  @@index([categoryId])
}

model RiskControlMapping {
  id                      String @id @default(cuid())
  riskId                  String
  controlImplementationId String

  risk                  Risk                  @relation(fields: [riskId], references: [id], onDelete: Cascade)
  controlImplementation ControlImplementation @relation(fields: [controlImplementationId], references: [id], onDelete: Cascade)

  @@unique([riskId, controlImplementationId])
}

// ─── Control Implementation ──────────────────────────────────────────────────

model ControlImplementation {
  id              String               @id @default(cuid())
  orgId           String
  controlId       String
  status          ControlImplStatus    @default(NOT_IMPLEMENTED)
  effectiveness   ControlEffectiveness @default(NOT_TESTED)
  description     String?              @db.Text
  implementedDate DateTime?
  frequency       String?
  automationLevel String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  org     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  control Control      @relation(fields: [controlId], references: [id])

  riskMappings RiskControlMapping[]
  evidences    Evidence[]
  tasks        Task[]

  @@unique([orgId, controlId])
  @@index([orgId])
}

// ─── Document Management ─────────────────────────────────────────────────────

model Document {
  id          String         @id @default(cuid())
  orgId       String
  title       String
  description String?        @db.Text
  status      DocumentStatus @default(DRAFT)
  category    String?
  reviewCycle Int?
  nextReview  DateTime?
  tags        String[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  versions  DocumentVersion[]
  approvals DocumentApproval[]

  @@index([orgId])
}

model DocumentVersion {
  id            String   @id @default(cuid())
  documentId    String
  versionNumber Int
  fileName      String
  fileUrl       String
  fileSize      Int?
  changelog     String?  @db.Text
  isActive      Boolean  @default(false)
  createdAt     DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
}

model DocumentApproval {
  id         String         @id @default(cuid())
  documentId String
  userId     String
  action     ApprovalAction
  stepOrder  Int
  comments   String?        @db.Text
  createdAt  DateTime       @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@index([documentId])
}

// ─── Audit Management ────────────────────────────────────────────────────────

model Audit {
  id         String      @id @default(cuid())
  orgId      String
  title      String
  type       AuditType   @default(INTERNAL)
  status     AuditStatus @default(PLANNED)
  scope      String?     @db.Text
  objectives String?     @db.Text
  startDate  DateTime?
  endDate    DateTime?
  reportDate DateTime?
  summary    String?     @db.Text
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  deletedAt  DateTime?

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  teamMembers    AuditTeamMember[]
  checklistItems AuditChecklistItem[]
  findings       AuditFinding[]

  @@index([orgId])
}

model AuditTeamMember {
  id      String @id @default(cuid())
  auditId String
  userId  String
  role    String @default("Auditor")

  audit Audit @relation(fields: [auditId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])

  @@unique([auditId, userId])
}

model AuditChecklistItem {
  id               String           @id @default(cuid())
  auditId          String
  clauseReference  String
  question         String           @db.Text
  complianceStatus ComplianceStatus @default(NOT_ASSESSED)
  notes            String?          @db.Text
  sortOrder        Int              @default(0)

  audit Audit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@index([auditId])
}

model AuditFinding {
  id          String          @id @default(cuid())
  auditId     String
  title       String
  description String?         @db.Text
  severity    FindingSeverity
  status      FindingStatus   @default(OPEN)
  rootCause   String?         @db.Text
  evidence    String?         @db.Text
  dueDate     DateTime?
  closedDate  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  audit Audit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@index([auditId])
}

// ─── Evidence ────────────────────────────────────────────────────────────────

model Evidence {
  id                      String       @id @default(cuid())
  orgId                   String
  controlImplementationId String?
  title                   String
  description             String?      @db.Text
  type                    EvidenceType @default(DOCUMENT)
  fileName                String?
  fileUrl                 String?
  expiryDate              DateTime?
  isValid                 Boolean      @default(true)
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt
  deletedAt               DateTime?

  org                   Organization          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  controlImplementation ControlImplementation? @relation(fields: [controlImplementationId], references: [id])

  @@index([orgId])
  @@index([controlImplementationId])
}

// ─── Task Management ─────────────────────────────────────────────────────────

model Task {
  id                      String       @id @default(cuid())
  orgId                   String
  title                   String
  description             String?      @db.Text
  status                  TaskStatus   @default(TODO)
  priority                TaskPriority @default(MEDIUM)
  assigneeId              String?
  creatorId               String?
  dueDate                 DateTime?
  completedAt             DateTime?
  riskId                  String?
  controlImplementationId String?
  capaId                  String?
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt
  deletedAt               DateTime?

  org                   Organization          @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignee              User?                 @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator               User?                 @relation("TaskCreator", fields: [creatorId], references: [id])
  risk                  Risk?                 @relation(fields: [riskId], references: [id])
  controlImplementation ControlImplementation? @relation(fields: [controlImplementationId], references: [id])
  capa                  CAPA?                 @relation(fields: [capaId], references: [id])

  @@index([orgId])
  @@index([assigneeId])
  @@index([status])
}

// ─── Statement of Applicability ──────────────────────────────────────────────

model SoAEntry {
  id            String              @id @default(cuid())
  orgId         String
  frameworkId   String
  controlId     String
  applicability ApplicabilityStatus @default(APPLICABLE)
  justification String?             @db.Text
  implStatus    ControlImplStatus   @default(NOT_IMPLEMENTED)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  framework Framework    @relation(fields: [frameworkId], references: [id])
  control   Control      @relation(fields: [controlId], references: [id])

  @@unique([orgId, frameworkId, controlId])
  @@index([orgId])
}

// ─── CAPA ────────────────────────────────────────────────────────────────────

model CAPA {
  id                 String     @id @default(cuid())
  orgId              String
  title              String
  description        String?    @db.Text
  type               CAPAType   @default(CORRECTIVE)
  status             CAPAStatus @default(OPEN)
  source             String?
  rootCauseMethod    String?
  rootCauseAnalysis  String?    @db.Text
  immediateAction    String?    @db.Text
  correctiveAction   String?    @db.Text
  preventiveAction   String?    @db.Text
  verificationMethod String?    @db.Text
  verificationResult String?    @db.Text
  verificationDate   DateTime?
  closureDate        DateTime?
  closureNotes       String?    @db.Text
  dueDate            DateTime?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  deletedAt          DateTime?

  org   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  tasks Task[]

  @@index([orgId])
}

// ─── Training ────────────────────────────────────────────────────────────────

model TrainingProgram {
  id             String   @id @default(cuid())
  orgId          String
  title          String
  description    String?  @db.Text
  frequency      String?
  isMandatory    Boolean  @default(false)
  validityPeriod Int?
  passingScore   Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  org     Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  records TrainingRecord[]

  @@index([orgId])
}

model TrainingRecord {
  id          String         @id @default(cuid())
  programId   String
  userId      String
  status      TrainingStatus @default(NOT_STARTED)
  score       Int?
  startedAt   DateTime?
  completedAt DateTime?
  expiresAt   DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  program TrainingProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  user    User            @relation(fields: [userId], references: [id])

  @@unique([programId, userId])
  @@index([userId])
}

// ─── Audit Log & Activity ────────────────────────────────────────────────────

model AuditLog {
  id         String         @id @default(cuid())
  orgId      String
  userId     String?
  action     ActivityAction
  entityType String
  entityId   String
  oldValues  Json?
  newValues  Json?
  metadata   Json?
  createdAt  DateTime       @default(now())

  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User?        @relation(fields: [userId], references: [id])

  @@index([orgId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ─── Notifications ───────────────────────────────────────────────────────────

model Notification {
  id        String           @id @default(cuid())
  orgId     String
  userId    String
  type      NotificationType
  title     String
  message   String?
  isRead    Boolean          @default(false)
  actionUrl String?
  createdAt DateTime         @default(now())

  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User         @relation(fields: [userId], references: [id])

  @@index([orgId])
  @@index([userId, isRead])
}

// ─── Tags & Comments ─────────────────────────────────────────────────────────

model Tag {
  id    String @id @default(cuid())
  orgId String
  name  String
  color String @default("#6B7280")

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, name])
  @@index([orgId])
}

model Comment {
  id         String    @id @default(cuid())
  orgId      String
  userId     String
  entityType String
  entityId   String
  content    String    @db.Text
  parentId   String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  org      Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user     User         @relation(fields: [userId], references: [id])
  parent   Comment?     @relation("CommentThread", fields: [parentId], references: [id])
  children Comment[]    @relation("CommentThread")

  @@index([orgId])
  @@index([entityType, entityId])
}
